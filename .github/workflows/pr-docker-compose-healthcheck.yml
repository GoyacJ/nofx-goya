name: PR Docker Compose Healthcheck

# Verify docker-compose.yml single-container healthcheck works on Alpine
on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - 'docker-compose.yml'
      - 'docker/Dockerfile.backend'
      - '.github/workflows/pr-docker-compose-healthcheck.yml'

jobs:
  healthcheck-test:
    name: Test Docker Compose Healthcheck
    runs-on: ubuntu-22.04
    timeout-minutes: 12
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create minimal .env for testing
        run: |
          JWT_SECRET="test-jwt-secret-123456789012345678901234"
          DATA_ENCRYPTION_KEY=$(openssl rand -base64 32)
          RSA_PRIVATE_KEY=$(openssl genrsa 2048 2>/dev/null | tr '\n' '\\' | sed 's/\\/\\n/g' | sed 's/\\n$//')

          cat > .env <<EOF_ENV
          # Minimal config for healthcheck testing
          NOFX_BACKEND_PORT=8080
          TZ=UTC
          JWT_SECRET=${JWT_SECRET}
          DATA_ENCRYPTION_KEY=${DATA_ENCRYPTION_KEY}
          RSA_PRIVATE_KEY=${RSA_PRIVATE_KEY}
          EOF_ENV

      - name: Start standalone service with docker compose
        run: |
          docker compose up -d
          echo "âœ… Service started, waiting for healthcheck..."

      - name: Wait for healthcheck start_period
        run: |
          echo "â³ Waiting 70 seconds for healthcheck start_period to complete..."
          sleep 70

      - name: Verify container healthcheck status
        run: |
          echo "ğŸ” Checking container health..."

          HEALTH=$(docker inspect nofx-trading --format='{{.State.Health.Status}}')
          echo "Health status: $HEALTH"

          if [ "$HEALTH" != "healthy" ]; then
            echo "âŒ Container is not healthy!"
            echo "Health status: $HEALTH"
            echo ""
            echo "Health logs:"
            docker inspect nofx-trading --format='{{json .State.Health}}' | jq
            echo ""
            echo "Container logs:"
            docker logs nofx-trading
            exit 1
          fi

          echo "âœ… Container is healthy"

      - name: Verify /api/health and /health endpoints
        run: |
          echo "ğŸ§ª Testing health endpoints..."

          curl -sf http://127.0.0.1:8080/api/health >/dev/null
          echo "âœ… /api/health works"

          curl -sf http://127.0.0.1:8080/health >/dev/null
          echo "âœ… /health works"

      - name: Verify healthcheck command is Alpine-compatible
        run: |
          echo "ğŸ” Verifying healthcheck command uses Alpine-compatible tool..."

          if grep -q 'test:.*curl' docker-compose.yml; then
            echo "âŒ ERROR: docker-compose.yml uses 'curl' which may not exist in Alpine"
            echo "Please use 'wget --no-verbose --tries=1 --spider'"
            exit 1
          fi

          if ! grep -q 'test:.*wget' docker-compose.yml; then
            echo "âš ï¸  WARNING: No wget healthcheck found in docker-compose.yml"
          else
            echo "âœ… Healthcheck uses Alpine-compatible 'wget' command"
          fi

      - name: Test healthcheck command inside container
        run: |
          echo "ğŸ§ª Testing healthcheck command directly..."
          docker exec nofx-trading wget --no-verbose --tries=1 --spider http://localhost:8080/health
          echo "âœ… Healthcheck command works"

      - name: Show container status
        if: always()
        run: |
          echo "ğŸ“Š Final container status:"
          docker ps --format "table {{.Names}}\t{{.Status}}"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "ğŸ“‹ Container logs:"
          docker logs nofx-trading

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          rm -f .env
