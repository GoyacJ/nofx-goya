name: PR Docker Build Check

# PR lightweight check for standalone backend image (embedded frontend)
on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - 'docker/**'
      - 'Dockerfile*'
      - 'go.mod'
      - 'go.sum'
      - '**.go'
      - 'web/**'
      - '.github/workflows/docker-build.yml'
      - '.github/workflows/pr-docker-check.yml'

jobs:
  docker-build-amd64:
    name: Build Check (backend amd64)
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image (amd64)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.backend
          platforms: linux/amd64
          push: false
          load: true
          tags: nofx-backend:pr-test
          cache-from: type=gha,scope=backend-amd64
          cache-to: type=gha,mode=max,scope=backend-amd64
          build-args: |
            BUILD_DATE=${{ github.event.pull_request.updated_at }}
            VCS_REF=${{ github.event.pull_request.head.sha }}
            VERSION=pr-${{ github.event.pull_request.number }}

      - name: Test run container (smoke test)
        timeout-minutes: 2
        run: |
          echo "üß™ Testing backend container startup..."

          JWT_SECRET="test-jwt-secret-123456789012345678901234"
          DATA_KEY=$(openssl rand -base64 32)
          RSA_KEY=$(openssl genrsa 2048 2>/dev/null | awk '{printf "%s\\n", $0}')

          docker run -d --name test-backend \
            -e API_SERVER_PORT=8080 \
            -e JWT_SECRET="$JWT_SECRET" \
            -e DATA_ENCRYPTION_KEY="$DATA_KEY" \
            -e RSA_PRIVATE_KEY="$RSA_KEY" \
            nofx-backend:pr-test

          for i in {1..30}; do
            if docker ps | grep -q test-backend; then
              echo "‚úÖ Container started successfully"
              docker logs test-backend | tail -20
              docker stop test-backend || true
              exit 0
            fi
            sleep 1
          done

          echo "‚ùå Container failed to start"
          docker logs test-backend || true
          exit 1

      - name: Check image size
        run: |
          SIZE=$(docker image inspect nofx-backend:pr-test --format='{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))

          echo "üì¶ Image size: ${SIZE_MB} MB"

          if [ $SIZE_MB -gt 700 ]; then
            echo "‚ö†Ô∏è  Warning: Backend image is larger than 700MB"
          else
            echo "‚úÖ Image size is within expected range"
          fi

  docker-build-arm64-native:
    name: Build Check (backend arm64 native)
    runs-on: ubuntu-22.04-arm
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image (arm64 native)
        uses: docker/build-push-action@v5
        timeout-minutes: 20
        with:
          context: .
          file: ./docker/Dockerfile.backend
          platforms: linux/arm64
          push: false
          load: true
          tags: nofx-backend:pr-test-arm64
          cache-from: type=gha,scope=backend-arm64
          cache-to: type=gha,mode=max,scope=backend-arm64
          build-args: |
            BUILD_DATE=${{ github.event.pull_request.updated_at }}
            VCS_REF=${{ github.event.pull_request.head.sha }}
            VERSION=pr-${{ github.event.pull_request.number }}

      - name: Test run ARM64 container
        timeout-minutes: 2
        run: |
          echo "üß™ Testing ARM64 backend container startup..."

          JWT_SECRET="test-jwt-secret-123456789012345678901234"
          DATA_KEY=$(openssl rand -base64 32)
          RSA_KEY=$(openssl genrsa 2048 2>/dev/null | awk '{printf "%s\\n", $0}')

          docker run -d --name test-backend-arm64 \
            -e API_SERVER_PORT=8080 \
            -e JWT_SECRET="$JWT_SECRET" \
            -e DATA_ENCRYPTION_KEY="$DATA_KEY" \
            -e RSA_PRIVATE_KEY="$RSA_KEY" \
            nofx-backend:pr-test-arm64

          for i in {1..30}; do
            if docker ps | grep -q test-backend-arm64; then
              echo "‚úÖ ARM64 container started successfully"
              docker logs test-backend-arm64 | tail -20
              docker stop test-backend-arm64 || true
              exit 0
            fi
            sleep 1
          done

          echo "‚ùå ARM64 container failed to start"
          docker logs test-backend-arm64 || true
          exit 1

  check-summary:
    name: Docker Build Summary
    needs: [docker-build-amd64, docker-build-arm64-native]
    runs-on: ubuntu-22.04
    if: always()
    permissions:
      pull-requests: write
    steps:
      - name: Check build results
        run: |
          echo "## üê≥ Docker Build Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.docker-build-amd64.result }}" == "success" ]]; then
            echo "‚úÖ **AMD64 build**: passed" >> $GITHUB_STEP_SUMMARY
            AMD64_OK=true
          else
            echo "‚ùå **AMD64 build**: failed" >> $GITHUB_STEP_SUMMARY
            AMD64_OK=false
          fi

          if [[ "${{ needs.docker-build-arm64-native.result }}" == "success" ]]; then
            echo "‚úÖ **ARM64 native build**: passed" >> $GITHUB_STEP_SUMMARY
            ARM64_OK=true
          else
            echo "‚ùå **ARM64 native build**: failed" >> $GITHUB_STEP_SUMMARY
            ARM64_OK=false
          fi

          if [ "$AMD64_OK" = true ] && [ "$ARM64_OK" = true ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üéâ All standalone image checks passed" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ùå Docker checks failed" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Comment on PR
        if: always() && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const amd64Status = '${{ needs.docker-build-amd64.result }}';
            const arm64Status = '${{ needs.docker-build-arm64-native.result }}';

            const successIcon = '‚úÖ';
            const failIcon = '‚ùå';

            const comment = [
              '## üê≥ Docker Build Check Results',
              '',
              `**Backend AMD64**: ${amd64Status === 'success' ? successIcon : failIcon} ${amd64Status}`,
              `**Backend ARM64 (native)**: ${arm64Status === 'success' ? successIcon : failIcon} ${arm64Status}`,
              '',
              amd64Status === 'success' && arm64Status === 'success'
                ? '### üéâ Standalone backend image checks passed!'
                : '### ‚ö†Ô∏è Some Docker checks failed. Please review logs in Actions.',
              '',
              '<sub>Checked image: nofx-backend (UI + API embedded)</sub>'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
